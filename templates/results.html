{% extends "base.html" %}

{% block title %}Analysis Results - {{ filename }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
                    <li class="breadcrumb-item"><a href="#">{{ filename }}</a></li>
                    <li class="breadcrumb-item active">Analysis Results</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-chart-bar"></i> Analysis Results: {{ filename }}
                    </h4>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-calculator"></i> Dataset Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stats-card text-center">
                                <h3 class="text-primary">{{ stats.shape[0] }}</h3>
                                <p class="text-muted mb-0">Total Rows</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card text-center">
                                <h3 class="text-success">{{ stats.shape[1] }}</h3>
                                <p class="text-muted mb-0">Total Columns</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card text-center">
                                <h3 class="text-warning">{{ stats.missing_values.values() | sum }}</h3>
                                <p class="text-muted mb-0">Missing Values</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card text-center">
                                <h3 class="text-info">{{ quality_report.duplicates }}</h3>
                                <p class="text-muted mb-0">Duplicate Rows</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Quality Report -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-check-circle"></i> Data Quality Score
                    </h5>
                </div>
                <div class="card-body">
                    {% for column, completeness in quality_report.completeness.items() %}
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span class="small">{{ column }}</span>
                            <span class="small">{{ "%.1f"|format(completeness) }}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar 
                                {% if completeness == 100 %}bg-success
                                {% elif completeness > 90 %}bg-warning
                                {% else %}bg-danger{% endif %}" 
                                style="width: {{ completeness }}%"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle"></i> Column Types
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <h6>Numeric Columns:</h6>
                            <ul class="list-unstyled">
                                {% for column in numeric_columns %}
                                <li><i class="fas fa-hashtag text-primary"></i> {{ column }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="col-6">
                            <h6>Text Columns:</h6>
                            <ul class="list-unstyled">
                                {% for column in columns %}
                                {% if column not in numeric_columns %}
                                <li><i class="fas fa-font text-secondary"></i> {{ column }}</li>
                                {% endif %}
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Visualizations -->
    {% if plots.distributions %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="plot-container">
                <h5 class="mb-3">
                    <i class="fas fa-chart-area"></i> Data Distributions
                </h5>
                <img src="data:image/png;base64,{{ plots.distributions }}" class="img-fluid" alt="Data Distributions">
            </div>
        </div>
    </div>
    {% endif %}

    {% if plots.correlation %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="plot-container">
                <h5 class="mb-3">
                    <i class="fas fa-fire"></i> Correlation Heatmap
                </h5>
                <img src="data:image/png;base64,{{ plots.correlation }}" class="img-fluid" alt="Correlation Heatmap">
                <div class="mt-3">
                    <p class="text-muted">
                        <i class="fas fa-info-circle"></i> 
                        Correlation values range from -1 to 1. Values close to 1 or -1 indicate strong relationships.
                    </p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-forward"></i> Next Steps
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <a href="{{ url_for('predict_page', filename=filename) }}" class="btn btn-custom w-100 mb-2">
                                <i class="fas fa-robot"></i> Build ML Model
                            </a>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-primary w-100 mb-2" onclick="downloadReport()">
                                <i class="fas fa-download"></i> Download Report
                            </button>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('upload_file') }}" class="btn btn-outline-secondary w-100 mb-2">
                                <i class="fas fa-upload"></i> Upload New Data
                            </a>
                        </div>
                    </div>

                    <div class="mt-3">
                        <h6>What you can do next:</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="list-unstyled small">
                                    <li><i class="fas fa-check text-success"></i> Build predictive models</li>
                                    <li><i class="fas fa-check text-success"></i> Perform feature selection</li>
                                    <li><i class="fas fa-check text-success"></i> Cross-validate models</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="list-unstyled small">
                                    <li><i class="fas fa-check text-success"></i> Generate predictions</li>
                                    <li><i class="fas fa-check text-success"></i> Export results</li>
                                    <li><i class="fas fa-check text-success"></i> Share insights</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Insights -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb"></i> Key Insights
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Data Quality:</h6>
                            <ul class="list-unstyled">
                                {% set completeness_avg = (quality_report.completeness.values() | sum) / (quality_report.completeness.values() | length) %}
                                <li>
                                    {% if completeness_avg >= 95 %}
                                    <i class="fas fa-check-circle text-success"></i> Excellent data quality ({{ "%.1f"|format(completeness_avg) }}% complete)
                                    {% elif completeness_avg >= 80 %}
                                    <i class="fas fa-exclamation-triangle text-warning"></i> Good data quality ({{ "%.1f"|format(completeness_avg) }}% complete)
                                    {% else %}
                                    <i class="fas fa-times-circle text-danger"></i> Poor data quality ({{ "%.1f"|format(completeness_avg) }}% complete)
                                    {% endif %}
                                </li>
                                
                                {% if quality_report.duplicates > 0 %}
                                <li><i class="fas fa-exclamation-triangle text-warning"></i> {{ quality_report.duplicates }} duplicate rows found</li>
                                {% else %}
                                <li><i class="fas fa-check-circle text-success"></i> No duplicate rows detected</li>
                                {% endif %}
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Recommendations:</h6>
                            <ul class="list-unstyled">
                                {% if numeric_columns | length >= 2 %}
                                <li><i class="fas fa-robot text-primary"></i> Ready for machine learning modeling</li>
                                {% endif %}
                                
                                {% if stats.missing_values.values() | sum > 0 %}
                                <li><i class="fas fa-tools text-warning"></i> Consider handling missing values</li>
                                {% endif %}
                                
                                {% if quality_report.duplicates > 0 %}
                                <li><i class="fas fa-broom text-info"></i> Remove duplicate rows for better analysis</li>
                                {% endif %}
                                
                                <li><i class="fas fa-chart-line text-success"></i> Explore feature relationships</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function downloadReport() {
    // Simple report generation - in a real app, this would generate a PDF
    const reportData = {
        filename: "{{ filename }}",
        analysis_date: new Date().toISOString(),
        summary: {
            rows: {{ stats.shape[0] }},
            columns: {{ stats.shape[1] }},
            missing_values: {{ stats.missing_values.values() | sum }},
            duplicates: {{ quality_report.duplicates }}
        }
    };
    
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(reportData, null, 2));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "analysis_report.json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
}
</script>
{% endblock %}
